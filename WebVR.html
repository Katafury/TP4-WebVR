<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>A-Frame – Déplacement avec joysticks</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

    <script>
      // Déplacement avec joystick gauche (avant / arrière / gauche / droite)
      AFRAME.registerComponent('joystick-move', {
        schema: {
          speed: {type:'number', default: 3},
          invertY: {type:'boolean', default: false}
        },
        init() {
          this.dir = new THREE.Vector3();
          this.el.addEventListener('thumbstickmoved', e => {
            let x = e.detail.x;
            let y = e.detail.y;
            if (Math.abs(x) < 0.05 && Math.abs(y) < 0.05) return;

            if (this.data.invertY) y = -y;

            const rig = document.querySelector('#rig');
            const cam = document.querySelector('#playerCam');

            cam.object3D.getWorldDirection(this.dir);
            this.dir.y = 0;
            this.dir.normalize();

            const side = new THREE.Vector3().crossVectors(new THREE.Vector3(0,1,0), this.dir).normalize();

            const move = new THREE.Vector3();
            move.addScaledVector(this.dir, -y);
            move.addScaledVector(side, x);
            move.multiplyScalar(this.data.speed * (this.delta || 0.016));
            rig.object3D.position.add(move);
          });
        },
        tick(t, dt){ this.delta = dt/1000; }
      });

      // Rotation avec joystick droit
      AFRAME.registerComponent('joystick-turn', {
        schema: { turnSpeed: {type:'number', default: 80} },
        init() {
          this.el.addEventListener('thumbstickmoved', e => {
            const x = e.detail.x;
            if (Math.abs(x) < 0.08) return;
            const rig = document.querySelector('#rig');
            rig.object3D.rotation.y -= THREE.MathUtils.degToRad(x * this.data.turnSpeed * (this.delta || 0.016));
          });
        },
        tick(t, dt){ this.delta = dt/1000; }
      });
    </script>
  </head>

  <body>
    <a-scene shadow="type: pcfsoft" renderer="antialias: true; colorManagement: true;">
      <!-- Lumières -->
      <a-entity light="type: directional; intensity: 1; castShadow: true" position="2 4 -3"></a-entity>
      <a-entity light="type: ambient; intensity: 0.4"></a-entity>

      <!-- Sol -->
      <a-plane rotation="-90 0 0" width="20" height="20" color="#7BC8A4" shadow="receive: true"></a-plane>

      <!-- Quelques objets repères -->
      <a-box position="0 0.5 -2" color="#4CC3D9" shadow="cast: true; receive: true"></a-box>
      <a-sphere position="2 1.25 -4" radius="1.25" color="#EF2D5E" shadow="cast: true; receive: true"></a-sphere>
      <a-cylinder position="-2 1 -4" radius="0.5" height="2" color="#FF5733" shadow="cast: true; receive: true"></a-cylinder>

      <!-- RIG du joueur -->
      <a-entity id="rig" position="0 1.6 0">
        <!-- Caméra -->
        <a-entity id="playerCam" camera look-controls></a-entity>

        <!-- Contrôleur gauche (déplacement) -->
        <a-entity hand-controls="hand: left" oculus-touch-controls="hand: left" joystick-move></a-entity>

        <!-- Contrôleur droit (rotation) -->
        <a-entity hand-controls="hand: right" oculus-touch-controls="hand: right" joystick-turn></a-entity>
      </a-entity>
    </a-scene>
  </body>
</html>


